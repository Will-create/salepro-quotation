<section class="hero-band">
  <div class="kicker">Marketplace</div>
  <h1 class="h1">Catalogue logiciels Yaar</h1>
  <p class="lead">Recherchez, filtrez et comparez les applications de notre base NoSQL. Vue grille/liste, filtres avances et tags intelligents inclus.</p>
</section>

<style>
@media(max-width:980px){
  #mpApp{grid-template-columns:1fr !important}
  #mpApp aside{position:static !important}
}
.tag-chip{display:inline-block;background:#eef3f8;color:#264459;border-radius:999px;padding:4px 9px;font-size:12px;font-weight:700}
</style>

<section class="section" id="mpApp" style="display:grid;grid-template-columns:280px 1fr;gap:16px;align-items:start;">
  <aside class="card" style="position:sticky;top:90px;">
    <h3 style="font-size:18px">Filtres avances</h3>

    <div style="margin-top:14px">
      <div class="badge">Type solution</div>
      <div style="display:grid;gap:7px;margin-top:9px;color:var(--muted);font-size:14px">
        <label><input type="checkbox" data-group="type" value="retail"/> Retail</label>
        <label><input type="checkbox" data-group="type" value="ecommerce"/> E-commerce</label>
        <label><input type="checkbox" data-group="type" value="restaurant"/> Restaurant</label>
        <label><input type="checkbox" data-group="type" value="hr"/> RH</label>
        <label><input type="checkbox" data-group="type" value="accounting"/> Comptabilite</label>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="badge">Mode deploiement</div>
      <div style="display:grid;gap:7px;margin-top:9px;color:var(--muted);font-size:14px">
        <label><input type="checkbox" data-group="deploy" value="local"/> Local</label>
        <label><input type="checkbox" data-group="deploy" value="cloud"/> Cloud</label>
        <label><input type="checkbox" data-group="deploy" value="hybrid"/> Hybride</label>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="badge">Mode tarifaire</div>
      <div style="display:grid;gap:7px;margin-top:9px;color:var(--muted);font-size:14px">
        <label><input type="checkbox" data-group="pricing" value="annual"/> Licence annuelle</label>
        <label><input type="checkbox" data-group="pricing" value="lifetime"/> Utilisation a vie</label>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="badge">Tags populaires</div>
      <div id="popularTags" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:9px"></div>
    </div>

    <button class="btn btn-outline" style="margin-top:15px;width:100%" id="clearFilters">Reinitialiser filtres</button>
  </aside>

  <div>
    <div class="card" style="padding:12px 14px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;flex:1;min-width:250px;">
        <input id="mpSearch" type="text" placeholder="Rechercher un logiciel, module, tag (ex: laravel, inventory, whatsapp)..." style="flex:1;min-width:230px;border:1px solid var(--line);border-radius:10px;padding:11px 12px;font-family:inherit"/>
        <select id="mpSort" style="border:1px solid var(--line);border-radius:10px;padding:11px 12px;font-family:inherit;background:#fff;color:var(--ink)">
          <option value="featured">Trier: mise en avant</option>
          <option value="name">Trier: nom A-Z</option>
          <option value="new">Trier: nouveaute</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <button class="btn btn-outline" id="gridViewBtn">Grille</button>
        <button class="btn btn-outline" id="listViewBtn">Liste</button>
      </div>
    </div>

    <div style="margin-top:10px;color:var(--muted);font-size:14px"><span id="resultCount">0</span> resultats</div>

    <div id="mpResults" class="grid-3" style="margin-top:12px"></div>
  </div>
</section>

<script>
(async function(){
  const mp = document.getElementById('mpApp');
  if(!mp) return;

  const state = {
    search:'',
    sort:'featured',
    view:'grid',
    filters:{ type:new Set(), deploy:new Set(), pricing:new Set() },
    DATA:[]
  };

  const resultsEl = document.getElementById('mpResults');
  const countEl = document.getElementById('resultCount');
  const popularTagsEl = document.getElementById('popularTags');

  function labelType(v){ return ({retail:'Retail',ecommerce:'E-commerce',restaurant:'Restaurant',hr:'RH',accounting:'Comptabilite'})[v]||v; }
  function labelDeploy(v){ return ({local:'Local',cloud:'Cloud',hybrid:'Hybride'})[v]||v; }

  function fmtCard(item){
    const tags = (item.tags || []).slice(0,4);
    return `
      <article class="card" style="padding:0;overflow:hidden;display:flex;flex-direction:column;">
        <div class="media" style="min-height:${state.view==='grid'?'170':'130'}px;border:none;border-bottom:1px solid var(--line);border-radius:0">
          <img src="${item.image}" alt="${item.name}"/>
        </div>
        <div style="padding:14px;display:flex;flex-direction:column;gap:8px;flex:1">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <h3 style="font-size:${state.view==='grid'?'20':'18'}px;">${item.name}</h3>
            ${item.isNew?'<span class="badge">Nouveau</span>':''}
          </div>
          <p class="muted" style="font-size:14px">${item.short || ''}</p>
          <div style="display:flex;flex-wrap:wrap;gap:6px">${(item.type||[]).map(t=>`<span class="badge">${labelType(t)}</span>`).join('')}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">${tags.map(t=>`<span class="tag-chip">#${t}</span>`).join('')}</div>
          <div style="margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div style="font-size:12px;color:var(--muted)">${(item.deploy||[]).map(labelDeploy).join(' Â· ')}</div>
            <a class="btn btn-dark" href="${item.link || '#'}" style="padding:9px 12px;font-size:13px">${item.cta || 'Voir'}</a>
          </div>
        </div>
      </article>
    `;
  }

  function passesFilters(item){
    const groups = ['type','deploy','pricing'];
    for (const g of groups){
      const selected = state.filters[g];
      if (selected.size===0) continue;
      const ok = (item[g] || []).some(v=>selected.has(v));
      if (!ok) return false;
    }
    const q = state.search.trim().toLowerCase();
    if(!q) return true;
    const hay = [item.name||'', item.short||'', ...(item.tags||[])].join(' ').toLowerCase();
    return hay.includes(q);
  }

  function sortItems(list){
    if(state.sort==='name') return list.slice().sort((a,b)=>(a.name||'').localeCompare((b.name||''),'fr'));
    if(state.sort==='new') return list.slice().sort((a,b)=>(b.isNew||0)-(a.isNew||0) || (b.featured||0)-(a.featured||0));
    return list.slice().sort((a,b)=>(b.featured||0)-(a.featured||0) || (b.isNew||0)-(a.isNew||0));
  }

  function render(){
    let list = state.DATA.filter(passesFilters);
    list = sortItems(list);

    resultsEl.className = state.view==='grid' ? 'grid-3' : '';
    resultsEl.style.display = 'grid';
    resultsEl.style.gridTemplateColumns = state.view==='grid' ? 'repeat(3,1fr)' : '1fr';
    resultsEl.style.gap = '14px';
    resultsEl.innerHTML = list.map(fmtCard).join('');
    countEl.textContent = list.length;
  }

  function buildPopularTags(){
    const freq = {};
    state.DATA.forEach(item => (item.tags || []).forEach(tag => freq[tag] = (freq[tag] || 0) + 1));
    const top = Object.keys(freq).sort((a,b)=>freq[b]-freq[a]).slice(0,12);
    popularTagsEl.innerHTML = top.map(t => `<button class="btn btn-outline" style="padding:6px 10px;font-size:12px" data-tag="${t}">#${t}</button>`).join('');
    popularTagsEl.querySelectorAll('button[data-tag]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('mpSearch').value = btn.getAttribute('data-tag') || '';
        state.search = document.getElementById('mpSearch').value;
        render();
      });
    });
  }

  document.getElementById('mpSearch').addEventListener('input',e=>{ state.search=e.target.value||''; render(); });
  document.getElementById('mpSort').addEventListener('change',e=>{ state.sort=e.target.value; render(); });

  document.querySelectorAll('input[data-group]').forEach(el=>{
    el.addEventListener('change',()=>{
      const g=el.getAttribute('data-group');
      const v=el.value;
      if(el.checked) state.filters[g].add(v); else state.filters[g].delete(v);
      render();
    });
  });

  document.getElementById('clearFilters').addEventListener('click',()=>{
    state.search='';
    state.sort='featured';
    state.filters.type.clear();
    state.filters.deploy.clear();
    state.filters.pricing.clear();
    document.getElementById('mpSearch').value='';
    document.getElementById('mpSort').value='featured';
    document.querySelectorAll('input[data-group]').forEach(i=>{ i.checked=false; });
    render();
  });

  document.getElementById('gridViewBtn').addEventListener('click',()=>{ state.view='grid'; render(); });
  document.getElementById('listViewBtn').addEventListener('click',()=>{ state.view='list'; render(); });

  try {
    const res = await fetch('/api/products/');
    const out = await res.json();
    state.DATA = (out && out.ok && Array.isArray(out.items)) ? out.items : [];
  } catch (e) {
    state.DATA = [];
  }

  buildPopularTags();
  render();
})();
</script>
