<section class="hero-band">
  <div class="kicker">Administration</div>
  <h1 class="h1">Dashboard Admin</h1>
  <p class="lead">Gestion des produits stockes en NoSQL (filtres marketplace, page produit et metadata).</p>
  <div class="actions">
    <button class="btn btn-light" id="btnReload">Recharger</button>
    <button class="btn btn-outline" id="btnLogout">Se deconnecter</button>
  </div>
</section>

<section class="section grid-3" id="statsRow">
  <article class="card"><h3 style="font-size:18px">Produits</h3><div id="sProducts" style="font-size:30px;font-weight:800;margin-top:8px">0</div></article>
  <article class="card"><h3 style="font-size:18px">Mises en avant</h3><div id="sFeatured" style="font-size:30px;font-weight:800;margin-top:8px">0</div></article>
  <article class="card"><h3 style="font-size:18px">Devis enregistres</h3><div id="sQuotes" style="font-size:30px;font-weight:800;margin-top:8px">0</div></article>
</section>

<section class="section grid-2">
  <article class="card" style="overflow:auto">
    <h3>Produits NoSQL</h3>
    <p class="muted" style="margin-top:6px">Cliquez sur une ligne pour charger le produit dans le formulaire.</p>
    <table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:14px" id="productsTable">
      <thead><tr style="text-align:left"><th style="padding:8px;border-bottom:1px solid var(--line)">Slug</th><th style="padding:8px;border-bottom:1px solid var(--line)">Nom</th><th style="padding:8px;border-bottom:1px solid var(--line)">Type</th></tr></thead>
      <tbody></tbody>
    </table>
  </article>

  <article class="card">
    <h3>Ajouter / Mettre a jour un produit</h3>
    <form id="productForm" style="margin-top:12px;display:grid;gap:9px">
      <input id="fSlug" placeholder="slug (optionnel, auto depuis nom)" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <input id="fName" placeholder="Nom du produit" required style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <textarea id="fShort" placeholder="Description courte" rows="3" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"></textarea>
      <input id="fType" placeholder="type (ex: retail,ecommerce,hr,accounting)" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <input id="fDeploy" placeholder="deploy (ex: local,cloud,hybrid)" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <input id="fPricing" placeholder="pricing (ex: annual,lifetime)" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <input id="fTags" placeholder="tags separes par virgule" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <input id="fImage" placeholder="URL image" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <input id="fLink" placeholder="Lien (ex: /salepro)" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <input id="fCta" placeholder="CTA (ex: Voir le produit)" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit"/>
      <div style="display:flex;gap:12px;font-size:14px;color:var(--muted)">
        <label><input type="checkbox" id="fFeatured"/> Mise en avant</label>
        <label><input type="checkbox" id="fNew"/> Nouveau</label>
      </div>
      <button class="btn btn-dark" type="submit">Enregistrer produit</button>
      <div id="formMsg" style="font-size:13px"></div>
    </form>
  </article>
</section>

<script>
let PRODUCTS = [];

function pick(id){ return document.getElementById(id); }

async function loadOverview(){
  const res = await fetch('/api/admin/overview/');
  const out = await res.json();
  if (!out.ok) return;
  pick('sProducts').textContent = out.stats.products;
  pick('sFeatured').textContent = out.stats.featuredProducts;
  pick('sQuotes').textContent = out.stats.quotes;
}

async function loadProducts(){
  const res = await fetch('/api/admin/products/');
  const out = await res.json();
  if (!out.ok) return;
  PRODUCTS = out.items || [];
  const tbody = pick('productsTable').querySelector('tbody');
  tbody.innerHTML = PRODUCTS.map(p => `
    <tr data-slug="${p.slug}" style="cursor:pointer">
      <td style="padding:8px;border-bottom:1px solid var(--line)">${p.slug||''}</td>
      <td style="padding:8px;border-bottom:1px solid var(--line)">${p.name||''}</td>
      <td style="padding:8px;border-bottom:1px solid var(--line)">${(p.type||[]).join(', ')}</td>
    </tr>
  `).join('');
  tbody.querySelectorAll('tr[data-slug]').forEach(tr => tr.addEventListener('click', () => fillForm(tr.getAttribute('data-slug'))));
}

function fillForm(slug){
  const p = PRODUCTS.find(x => x.slug === slug);
  if (!p) return;
  pick('fSlug').value = p.slug || '';
  pick('fName').value = p.name || '';
  pick('fShort').value = p.short || '';
  pick('fType').value = (p.type || []).join(',');
  pick('fDeploy').value = (p.deploy || []).join(',');
  pick('fPricing').value = (p.pricing || []).join(',');
  pick('fTags').value = (p.tags || []).join(',');
  pick('fImage').value = (p.images && p.images.hero) || p.image || '';
  pick('fLink').value = p.link || '';
  pick('fCta').value = p.cta || '';
  pick('fFeatured').checked = !!p.featured;
  pick('fNew').checked = !!p.isNew;
}

pick('productForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const msg = pick('formMsg');
  msg.textContent = '';
  const payload = {
    slug: pick('fSlug').value,
    name: pick('fName').value,
    short: pick('fShort').value,
    type: pick('fType').value,
    deploy: pick('fDeploy').value,
    pricing: pick('fPricing').value,
    tags: pick('fTags').value,
    image: pick('fImage').value,
    link: pick('fLink').value,
    cta: pick('fCta').value,
    featured: pick('fFeatured').checked ? 1 : 0,
    isNew: pick('fNew').checked ? 1 : 0
  };
  try {
    const res = await fetch('/api/admin/products/upsert/', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const out = await res.json();
    if (!out.ok) {
      msg.style.color = '#b42318';
      msg.textContent = out.error || 'Erreur';
      return;
    }
    msg.style.color = '#166534';
    msg.textContent = 'Produit enregistre';
    await loadProducts();
    await loadOverview();
  } catch (err) {
    msg.style.color = '#b42318';
    msg.textContent = 'Erreur reseau';
  }
});

pick('btnReload').addEventListener('click', async () => {
  await loadOverview();
  await loadProducts();
});

pick('btnLogout').addEventListener('click', async () => {
  await fetch('/admin/logout/', { method:'POST' });
  location.href = '/admin/';
});

(async function init(){
  await loadOverview();
  await loadProducts();
})();
</script>
